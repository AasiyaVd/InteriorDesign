<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>La Obsidiané | Design Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
<script src="ai-room-check.js"></script>

<style>

/* RESET */
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{
  font-family:'Poppins',sans-serif;
  background:#fff;
  color:#f5f5f5;
  overflow:hidden;
}

/* NAVBAR */
.navbar{
  height:60px;
  background:rgba(75,0,7);
  border-bottom:1px solid rgba(255,215,160,0.15);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 24px;
  font-family:'Cormorant Garamond',serif;
  letter-spacing:1px;
  font-size:20px;
}

/* RIGHT ACTION GROUP */
.nav-right{
  display:flex;
  align-items:center;
  gap:12px;
}

/* RENDER BUTTON (PRIMARY) */
.render-nav-btn{
  background:rgba(75,0,7);
  border:1px solid rgba(255,215,160,0.45);
  color:#d4af37;
  padding:8px 16px;
  border-radius:10px;
  cursor:pointer;
  font-size:13px;
  transition:0.3s;
}

.render-nav-btn:hover{
  background:#d4af37;
  color:#000;
}

/* ICON BUTTONS */
.nav-icon{
  background:transparent;
  border:1px solid rgba(255,215,160,0.25);
  width:36px;
  height:36px;
  border-radius:8px;
  color:#d4af37;
  cursor:pointer;
  transition:0.3s;
}

.nav-icon:hover{
  background:#d4af37;
  color:#000;
}

/* DANGER ACTION (DELETE) */
.nav-icon.danger{
  color:#d4af37;
  border-color:rgba(178,58,58,0.5);
}

.nav-icon.danger:hover{
  background:#b23a3a;
  color:#fff;
}

/* APP LAYOUT */
.app{
  display:grid;
  grid-template-columns:50px 0px 1fr; /* sidebar | toolpanel | canvas */
  height:calc(100vh - 60px);
  transition: grid-template-columns .35s ease;
}

/* SIDEBAR */
.sidebar{
  background:rgba(75, 0, 7);
  border-right:1px solid rgba(255,215,160,0.12);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding-top:20px;
  gap:26px;
  width: 50px;
}

.side-btn{
  font-size:20px;
  color:#d4af37;
  cursor:pointer;
  transition:0.3s;
  background:rgba(75, 0, 7);
  border: none;
}

.sidebar i:hover{
  color:#f5f4f2
}

/* CANVAS */
.canvas-area{
  position:relative;
  background:#f5f4f2;
  margin:15px;
  border-radius:22px;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
  height:95%;
  transition: .35s ease; /* smooth resize */
}

/* FLOATING ACTION BAR */
.action-bar{
  position:absolute;
  bottom:24px;
  right:24px;
  background:#111;
  border:1px solid rgba(255,215,160,0.2);
  border-radius:12px;
  padding:8px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.action-bar button{
  background:#0e0e0e;
  border:1px solid rgba(255,215,160,0.25);
  color:#f5f5f5;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  font-size:13px;
  transition:0.3s;
}

.action-bar button:hover{
  background:#d4af37;
  color:#000;
}

.logo-group{display:flex;gap:10px}
.crown-img{height:48px}
.label-img{
height:30px;
margin-top: 10px;
}

/* PROJECT TITLE (CENTER) */
.project-title-wrapper{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
}

.project-title-input{
  background:transparent;
  border:none;
  outline:none;
  text-align:center;
  font-family:'Cormorant Garamond',serif;
  font-size:15px;
  letter-spacing:1px;
  color:#f5f5f5;
  padding:4px 10px;
  border-radius:6px;
  transition:0.3s;
  min-width:220px;
}

/* Hover & Focus */
.project-title-input:hover{
  background:rgba(255,255,255,0.06);
}

.project-title-input:focus{
  background:rgba(255,255,255,0.1);
  box-shadow:0 0 0 1px rgba(255,215,160,0.4);
}

.sidebar i.active{
  color:#d4af37;
}

.toast{
  position: fixed;
  bottom: 40px;
  right: 40px;
  background:#1a7f37;
  color:#fff;
  padding:14px 20px;
  border-radius:10px;
  font-size:14px;
  opacity:0;
  transition:opacity .3s ease;
  z-index:99999;
  pointer-events: none
}
/* UPLOAD STATE */
.empty-state{
  position:absolute;
  z-index:10;
  border:2px dashed #bdbdbd;
  padding:46px 60px;
  text-align:center;
  cursor:pointer;
  background:#f8f7f5;
  border-radius:18px;
}

.empty-state h2{
  font-family:'Cormorant Garamond',serif;
  margin-bottom:6px;
  font-weight:600;
  color:#000;
}

.empty-state p{
  font-size:14px;
  color:#555;
  margin-bottom:14px;
}

.empty-state button{
  display:inline-block;
  background:#5b0f14;
  color:#fff;
  padding:10px 18px;
  border-radius:8px;
  cursor:pointer;
  font-size:13px;
  border: none;
}

.user-icon{width:22px;
  stroke:#d0b75b;
  stroke-width:1.4;
  fill:none;
  background:transparent;
  border:1px solid rgba(255,215,160,0.25);
  width:33px;
  height:30px;
  border-radius:8px;
  cursor:pointer;
  transition:0.3s;}

.user-icon:hover{
    background:#d4af37;
  stroke:#000;
}

.canvas{
  width:100%;height:100%;
  background:#f5f4f2;border-radius:20px;
  position:relative;display:flex;justify-content:center;align-items:center;
  user-select: none;
}

img {
  -webkit-user-drag: none;
  -khtml-user-drag: none;
  -moz-user-drag: none;
  -o-user-drag: none;
  -user-drag: none;

}

.canvas-wrapper{
  position:absolute;
  z-index:10;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:2px;
  box-sizing:content-box;
}

.canvas-wrapper.selected{
  outline:2px solid #c0a062;
}

.canvas-wrapper.selected .delete-btn{
  display:flex;
}

.canvas-wrapper img{
  display:block;              /* removes inline gap */
  max-width:100%;
  height:auto;
    position:relative;
  z-index:1;
}

.empty-state{
  z-index:10;
}

#room{
  position:absolute;inset:0;width:100%;height:100%;
  object-fit:cover;border-radius:20px
}


/* TOOL PANEL */
.tool-panel{
  background:#f5f4f2;
  border-right:1px solid rgba(0,0,0,.08);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  display: flex;
  flex-direction: column;
}

.tool-panel.active{width:260px}

.tool-panel-header{
  padding:18px;font-size:14px;font-weight:500;
  border-bottom:1px solid rgba(0,0,0,.1);
  display:flex;align-items:center;gap:12px;
}
.panel-back{background:none;border:none;cursor:pointer;color:rgba(75,0,7)}

.panel-back:hover{opacity:.7}

.tool-panel-content{
  padding:16px;display:grid;gap:14px;color: black;
  max-height:calc(100vh - 140px);overflow-y:auto;
}

.tool-panel-content img{width:100%;border-radius:10px;cursor:pointer}

.canvas-error{
  position:absolute;
  top:24px;
  left:50%;
  transform:translateX(-50%);
  background:#6b0008;
  color:#fff;
  padding:10px 18px;
  border-radius:10px;
  font-size:13px;
  opacity:0;
  pointer-events:none;
  transition:.3s ease;
  z-index:30;
}

.canvas-error.show{
  opacity:1;
}

</style>
</head>

<body>
<script src="auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  if (typeof saveRedirectIfNotAuth !== "function") {
    console.error("Auth not ready");
    return;
  }

  saveRedirectIfNotAuth();
  protectPage();
  setupNavbarAuth();
});
</script>



<div class="navbar">

  <!-- LEFT: LOGO -->
  <a href="home.html" style="text-decoration:none;">
    <div class="logo-group">
      <img class="crown-img" src="crown.png">
      <img class="label-img" src="label.png">
    </div>
  </a>

  <!-- CENTER: PROJECT TITLE -->
  <div class="project-title-wrapper">
    <input 
      type="text" 
      class="project-title-input" 
      value="Untitled Design"
      spellcheck="false"
    />
  </div>

  <!-- RIGHT: ACTIONS -->
  <div class="nav-right">
<button
  class="render-nav-btn"
  id="nextBtn"
  type="button"
> Next</button>

<button class="nav-icon danger" id="deleteBtn" title="Delete" type="button">
  <i class="fa-solid fa-trash"></i>
</button>

<i>
  <svg
    class="user-icon"
    viewBox="0 0 24 24"
    onclick="event.stopPropagation(); window.location.href='dashboard.html';"
    style="cursor:pointer"
  >
    <circle cx="12" cy="8" r="4"></circle>
    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path>
  </svg>
</i>
</div>
</div>

<div class="app">
  <!-- SIDEBAR -->
  <div class="sidebar">

      <button class="side-btn" data-tooltip="Upload Image" onclick="uploadRoom()" title="Upload">
    <i class="fa-solid fa-upload"></i>
  </button>
      <button class="side-btn" data-tooltip="Templates" onclick="openPanel('Templates')" title="Templates">
    <i class="fa-regular fa-image"></i>
  </button>
</div>

<div class="tool-panel" id="toolPanel">
  <div class="tool-panel-header">
    <button class="panel-back" onclick="panelBack()">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <span id="panelTitle"></span>
  </div>
  <div class="tool-panel-content" id="panelContent"></div>
</div>

<!-- CANVAS -->
  <div class="canvas-area">
  <div class="canvas" id="canvas">

 <div class="empty-state">
  <h2>Step 1: Upload Your Room</h2>
  <p>
    Upload a clear image of your room.<br>
    This will be the base for your design.
  </p>
  <p style="font-size:13px;opacity:.7;margin-bottom:16px">
    After uploading, click <b>Next</b> to start designing.
  </p>
  <button onclick="uploadRoom()">Upload Image</button>
</div>
<div class="canvas-error" id="canvasError">
  Please upload or select a room image first
</div>

</div>
</div>

</div>



<script>
/* SAFE DEFAULTS */
window.roomReady = false;
window.beforeRoomImage = null;
window.historyStack = [];
window.MAX_HISTORY = 50;

let designState = JSON.parse(sessionStorage.getItem("design_draft")) || {
  roomImage: null,
  title: "Untitled Design",
  furniture: []
};
</script>

<script>
const canvas=document.getElementById("canvas");
const panel=document.getElementById("toolPanel");
const panelTitle=document.getElementById("panelTitle");
const panelContent=document.getElementById("panelContent");


function showCanvasError(msg) {
  const el = document.getElementById("canvasError");
  if (!el) return;

  el.innerText = msg;
  el.classList.add("show");

  clearTimeout(el._timeout);
  el._timeout = setTimeout(() => {
    el.classList.remove("show");
  }, 2500);
}

function hideEmptyState(){
  const empty = canvas.querySelector(".empty-state");
  if(empty) empty.remove();
}

function persistDesignState() {
  sessionStorage.setItem(
    "design_draft",
    JSON.stringify(designState)
  );
}

function renderCanvas() {
  canvas.innerHTML = "";

  if (designState.roomImage) {
    const room = document.createElement("img");
    room.id = "room";
    room.src = designState.roomImage;
    canvas.appendChild(room);
    roomReady = true;
  }

  hideEmptyState();
}
 
function uploadRoom() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";

  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);

    img.onload = async () => {
      const allowed = await checkIfRoom(img);
      beforeRoomImage = img.src;

      if (!allowed) {
        alert("❌ This is not a room image.");
        return;
      }

      // ✅ ONLY THIS (IMPORTANT)
      designState.roomImage = img.src;

      persistDesignState();
      renderCanvas();

      roomReady = true;
      hideEmptyState();
      updateNextButton();

      console.log("ROOM IMAGE SAVED ✅", designState.roomImage);
    };
  };

  input.click();
}

function loadSample(src){
  canvas.innerHTML = "";

  const img = document.createElement("img");
  img.id = "room";
  img.src = src;
  beforeRoomImage = src;

  canvas.appendChild(img);

  designState.roomImage = src;   // ✅ ADD THIS
  persistDesignState();          // ✅ ADD THIS
  
  roomReady = true;
  hideEmptyState();
}

const app = document.querySelector(".app");


function openPanelGrid(){
  app.style.gridTemplateColumns = "50px 260px 1fr";
}

function closePanelGrid(){
  app.style.gridTemplateColumns = "50px 0px 1fr";
}

function openPanel(type){
  openPanelGrid();
  panel.classList.add("active");

  panelContent.innerHTML="";
  panelTitle.innerText=type;

  if(type==="Templates"){
    panelState="templates";
    panelContent.innerHTML=`
      <img src="template/e7.jpg" onclick="loadSample(this.src)">
      <img src="template/e9.jpg" onclick="loadSample(this.src)">
      <img src="template/e6.jpg" onclick="loadSample(this.src)">
      <img src="template/e4.jpg" onclick="loadSample(this.src)">
      <img src="template/e3.jpg" onclick="loadSample(this.src)">
      <img src="template/e5.jpg" onclick="loadSample(this.src)">
      <img src="template/e2.jpg" onclick="loadSample(this.src)">
      <img src="template/e1.jpg" onclick="loadSample(this.src)">
    `;
  }

  if(type==="decor"){
    panelState="decor";
    panelContent.innerHTML=`<p>Decor items here</p>`;
  }

  if(type==="wall"){
    panelState="wall";
    panelContent.innerHTML=`<p>Wall colors here</p>`;
  }
}

function saveHistory() {
  historyStack.push(JSON.stringify(designState));
  if (historyStack.length > MAX_HISTORY) {
    historyStack.shift();
  }
}

function deleteSelected() {
  if (!selectedWrapper) {
    showCanvasError("No item selected");
    return;
  }

  saveHistory();

  const src = selectedItem.src;

  designState.furniture = designState.furniture.filter(
    f => f.src !== src
  );

  selectedWrapper.remove();
  selectedWrapper = null;
  selectedItem = null;
}

function saveLocalDraft() {
  localStorage.setItem(
    "design_draft",
    JSON.stringify(designState)
  );
}

async function goToPreview() {
  if (!roomReady) {
    showCanvasError("Upload a room image first");
    return;
  }

  sessionStorage.setItem(
    "design_draft",
    JSON.stringify(designState)
  );

  const canvasArea = document.getElementById("canvas");

  const screenshot = await html2canvas(canvasArea, {
    backgroundColor: null,
    useCORS: true,
    scale: 1.1
  });

  const afterImage = screenshot.toDataURL("image/png");

  sessionStorage.setItem("preview_before", beforeRoomImage);
  sessionStorage.setItem("preview_after", afterImage);

  window.location.href = "preview.html";
}

//dlt btn logic
const deleteBtn = document.getElementById("deleteBtn");

deleteBtn.addEventListener("click", () => {
  resetCanvasToInitialState();
});

function resetCanvasToInitialState() {
  // 1. Reset state
  designState.roomImage = null;
  designState.furniture = [];
  roomReady = false;
  beforeRoomImage = null;

  // 2. Clear storage
  sessionStorage.removeItem("design_draft");

  // 3. Clear canvas completely
  canvas.innerHTML = "";

  // 4. Restore empty upload state
  const emptyState = document.createElement("div");
  emptyState.className = "empty-state";
  emptyState.innerHTML = `
    <h2>Upload your room image</h2>
    <p>Start designing with luxury precision</p>
    <button onclick="uploadRoom()">Upload Image</button>
  `;

  canvas.appendChild(emptyState);

  // 5. Close side panel if open
  panel.classList.remove("active");
  panelContent.innerHTML = "";
  panelTitle.innerText = "";
  panelState = "root";
  closePanelGrid();
}

//back btn on tool panel
function panelBack() {
  panel.classList.remove("active");
  panelContent.innerHTML = "";
  panelTitle.innerText = "";
  panelState = "root";
  closePanelGrid();
}

//next btn disable
function updateNextButton() {
  if (!roomReady) {
    nextBtn.style.opacity = "0.4";
    nextBtn.style.pointerEvents = "auto"; // allow click to show error
    nextBtn.style.cursor = "not-allowed";
  } else {
    nextBtn.style.opacity = "1";
    nextBtn.style.cursor = "pointer";
  }
}

document.getElementById("nextBtn").addEventListener("click", () => {
  console.log("✅ NEXT BUTTON CLICKED");
  console.log("designState =", designState);
  console.log("roomImage =", designState?.roomImage);

  if (!designState || !designState.roomImage) {
    alert("❌ Upload a room template first!");
    return;
  }

  sessionStorage.setItem("design_draft", JSON.stringify(designState));
  alert("✅ Template saved! Redirecting...");
  window.location.href = "furniture.html";
});


</script>

</body>
</html>




